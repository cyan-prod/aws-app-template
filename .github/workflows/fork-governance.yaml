name: Fork Governance

on:
  fork:

jobs:
  setup-forked-repo:
    name: Apply governance to forked repository
    runs-on: ubuntu-latest
    steps:
      - name: Checkout template repository
        uses: actions/checkout@v4

      - name: Get forked repository details
        id: fork-info
        uses: actions/github-script@v7
        with:
          script: |
            const forkOwner = context.payload.forkee.owner.login;
            const forkRepo = context.payload.forkee.name;
            const forkFullName = context.payload.forkee.full_name;
            const forkUrl = context.payload.forkee.html_url;

            console.log(`Fork detected: ${forkFullName}`);
            console.log(`URL: ${forkUrl}`);

            core.setOutput('owner', forkOwner);
            core.setOutput('repo', forkRepo);
            core.setOutput('full_name', forkFullName);
            core.setOutput('url', forkUrl);

      - name: Validate repository naming convention
        id: validate-name
        uses: actions/github-script@v7
        with:
          script: |
            const repoName = '${{ steps.fork-info.outputs.repo }}';
            const namePattern = /^aws-[a-z0-9]+(-[a-z0-9]+)*$/;

            console.log(`Validating repository name: ${repoName}`);

            if (!namePattern.test(repoName)) {
              console.log('âŒ Repository name does NOT follow convention');

              let issues = [];

              if (!repoName.startsWith('aws-')) {
                issues.push('Must start with "aws-"');
              }

              if (repoName !== repoName.toLowerCase()) {
                issues.push('Must be all lowercase');
              }

              if (repoName.includes('_')) {
                issues.push('Use hyphens (-) not underscores (_)');
              }

              if (/[A-Z]/.test(repoName)) {
                issues.push('No uppercase letters allowed');
              }

              const suggestion = repoName
                .toLowerCase()
                .replace(/[_\s]+/g, '-')
                .replace(/^(?!aws-)/, 'aws-');

              core.setOutput('valid', 'false');
              core.setOutput('issues', issues.join('; '));
              core.setOutput('suggestion', suggestion);
            } else {
              console.log('âœ“ Repository name follows convention');
              core.setOutput('valid', 'true');
            }

      - name: Apply repository rulesets
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GH_PAT }}
          script: |
            const fs = require('fs');
            const path = require('path');

            const forkOwner = '${{ steps.fork-info.outputs.owner }}';
            const forkRepo = '${{ steps.fork-info.outputs.repo }}';

            console.log(`\nApplying rulesets to ${forkOwner}/${forkRepo}...\n`);

            const rulesetDir = 'rulesets';
            const rulesetFiles = fs.readdirSync(rulesetDir)
              .filter(file => file.endsWith('.json'));

            const results = [];

            for (const file of rulesetFiles) {
              const filePath = path.join(rulesetDir, file);
              const rulesetConfig = JSON.parse(fs.readFileSync(filePath, 'utf8'));

              console.log(`Processing: ${file} - ${rulesetConfig.name}`);

              try {
                const response = await github.rest.repos.createRepoRuleset({
                  owner: forkOwner,
                  repo: forkRepo,
                  ...rulesetConfig
                });

                console.log(`âœ“ Applied: ${rulesetConfig.name} (ID: ${response.data.id})`);
                results.push({ file, status: 'success', name: rulesetConfig.name });
              } catch (error) {
                console.error(`âœ— Failed: ${rulesetConfig.name} - ${error.message}`);
                results.push({ file, status: 'failed', name: rulesetConfig.name, error: error.message });
              }
            }

            const successCount = results.filter(r => r.status === 'success').length;
            const failCount = results.filter(r => r.status === 'failed').length;

            console.log(`\n=== Summary ===`);
            console.log(`Total: ${results.length} | Success: ${successCount} | Failed: ${failCount}`);

            return results;

      - name: Create dev branch and set as default
        uses: actions/github-script@v7
        continue-on-error: true
        with:
          github-token: ${{ secrets.GH_PAT }}
          script: |
            const forkOwner = '${{ steps.fork-info.outputs.owner }}';
            const forkRepo = '${{ steps.fork-info.outputs.repo }}';

            try {
              // Check if dev branch exists
              await github.rest.repos.getBranch({
                owner: forkOwner,
                repo: forkRepo,
                branch: 'dev'
              });
              console.log('Dev branch already exists');
            } catch (error) {
              if (error.status === 404) {
                console.log('Creating dev branch...');

                // Get main branch ref
                const mainBranch = await github.rest.repos.getBranch({
                  owner: forkOwner,
                  repo: forkRepo,
                  branch: 'main'
                });

                // Create dev branch from main
                await github.rest.git.createRef({
                  owner: forkOwner,
                  repo: forkRepo,
                  ref: 'refs/heads/dev',
                  sha: mainBranch.data.commit.sha
                });

                console.log('âœ“ Dev branch created');
              } else {
                throw error;
              }
            }

            // Set dev as default branch
            try {
              await github.rest.repos.update({
                owner: forkOwner,
                repo: forkRepo,
                default_branch: 'dev'
              });
              console.log('âœ“ Set dev as default branch');
            } catch (error) {
              console.error('Failed to set default branch:', error.message);
            }

      - name: Create environments
        uses: actions/github-script@v7
        continue-on-error: true
        with:
          github-token: ${{ secrets.GH_PAT }}
          script: |
            const forkOwner = '${{ steps.fork-info.outputs.owner }}';
            const forkRepo = '${{ steps.fork-info.outputs.repo }}';

            const environments = ['dev', 'staging', 'prod'];

            for (const env of environments) {
              try {
                await github.rest.repos.createOrUpdateEnvironment({
                  owner: forkOwner,
                  repo: forkRepo,
                  environment_name: env
                });
                console.log(`âœ“ Created environment: ${env}`);
              } catch (error) {
                console.error(`Failed to create ${env}:`, error.message);
              }
            }

      - name: Enable security features
        uses: actions/github-script@v7
        continue-on-error: true
        with:
          github-token: ${{ secrets.GH_PAT }}
          script: |
            const forkOwner = '${{ steps.fork-info.outputs.owner }}';
            const forkRepo = '${{ steps.fork-info.outputs.repo }}';

            // Enable vulnerability alerts
            try {
              await github.rest.repos.enableVulnerabilityAlerts({
                owner: forkOwner,
                repo: forkRepo
              });
              console.log('âœ“ Enabled vulnerability alerts');
            } catch (error) {
              console.error('Failed to enable vulnerability alerts:', error.message);
            }

            // Enable automated security fixes (Dependabot)
            try {
              await github.rest.repos.enableAutomatedSecurityFixes({
                owner: forkOwner,
                repo: forkRepo
              });
              console.log('âœ“ Enabled Dependabot security updates');
            } catch (error) {
              console.error('Failed to enable Dependabot:', error.message);
            }

            // Enable auto-delete head branches
            try {
              await github.rest.repos.update({
                owner: forkOwner,
                repo: forkRepo,
                delete_branch_on_merge: true
              });
              console.log('âœ“ Enabled auto-delete branch after merge');
            } catch (error) {
              console.error('Failed to enable auto-delete:', error.message);
            }

      - name: Check required files updated
        id: check-files
        uses: actions/github-script@v7
        continue-on-error: true
        with:
          github-token: ${{ secrets.GH_PAT }}
          script: |
            const forkOwner = '${{ steps.fork-info.outputs.owner }}';
            const forkRepo = '${{ steps.fork-info.outputs.repo }}';

            const requiredFiles = ['README.md', 'CONTRIBUTING.md'];
            const warnings = [];

            for (const file of requiredFiles) {
              try {
                const { data } = await github.rest.repos.getContent({
                  owner: forkOwner,
                  repo: forkRepo,
                  path: file
                });

                const content = Buffer.from(data.content, 'base64').toString();

                // Check if file still contains template placeholder text
                if (file === 'README.md') {
                  if (content.includes('Template repo to spin off application on AWS')) {
                    warnings.push('README.md still contains template text - needs customization');
                  }
                }

                if (file === 'CONTRIBUTING.md') {
                  if (content.includes('aws-app-template')) {
                    warnings.push('CONTRIBUTING.md still references template name - needs update');
                  }
                }

                console.log(`âœ“ ${file} exists`);
              } catch (error) {
                warnings.push(`${file} is missing`);
                console.error(`âœ— ${file} not found`);
              }
            }

            core.setOutput('warnings', warnings.join('; '));
            return warnings;

      - name: Create setup notification issue
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GH_PAT }}
          script: |
            const forkOwner = '${{ steps.fork-info.outputs.owner }}';
            const forkRepo = '${{ steps.fork-info.outputs.repo }}';
            const nameValid = '${{ steps.validate-name.outputs.valid }}';
            const nameIssues = '${{ steps.validate-name.outputs.issues }}';
            const nameSuggestion = '${{ steps.validate-name.outputs.suggestion }}';
            const fileWarnings = '${{ steps.check-files.outputs.warnings }}';

            let body = `# ðŸŽ‰ Repository Setup Complete\n\n`;
            body += `This repository has been forked from the AWS app template and governance rules have been applied.\n\n`;

            // Naming validation
            body += `## ðŸ“ Repository Naming\n\n`;
            if (nameValid === 'true') {
              body += `âœ… **Repository name follows convention**: \`${forkRepo}\`\n\n`;
            } else {
              body += `âš ï¸ **Repository name does NOT follow convention**\n\n`;
              body += `**Current name:** \`${forkRepo}\`\n`;
              body += `**Issues:** ${nameIssues}\n`;
              body += `**Suggested name:** \`${nameSuggestion}\`\n\n`;
              body += `**Convention:** Repository names must:\n`;
              body += `- Start with \`aws-\`\n`;
              body += `- Use lowercase letters only\n`;
              body += `- Use kebab-case (hyphens, not underscores)\n`;
              body += `- Example: \`aws-user-service\`, \`aws-payment-api\`\n\n`;
              body += `To rename: **Settings** â†’ **General** â†’ **Repository name**\n\n`;
            }

            // Applied rules
            body += `## ðŸ”’ Applied Governance Rules\n\n`;
            body += `The following rulesets have been applied:\n\n`;
            body += `- âœ… **Branch Protection** - \`main\` and \`dev\` require PR approval\n`;
            body += `- âœ… **Tag Protection** - \`v*\` tags cannot be force-pushed or deleted\n`;
            body += `- âœ… **Branch Naming** - Must follow \`type/jira-123\` pattern (lowercase, kebab-case)\n`;
            body += `- âœ… **Commit Messages** - Must follow \`jira-123: description\` pattern (lowercase)\n\n`;

            // Required status checks
            body += `## âš™ï¸ Required Status Checks\n\n`;
            body += `Before merging to \`main\` or \`dev\`, these checks must pass:\n\n`;
            body += `- \`pr-checks\` - Linting, formatting, testing\n`;
            body += `- \`static-code-scan\` - Security and code quality scanning\n`;
            body += `- \`terraform-plan\` - Infrastructure validation\n\n`;
            body += `**Action Required:** Create these workflow files in \`.github/workflows/\`\n\n`;

            // Branch setup
            body += `## ðŸŒ¿ Branch Setup\n\n`;
            body += `- âœ… \`main\` - Production branch (protected)\n`;
            body += `- âœ… \`dev\` - Development branch (protected, **default**)\n\n`;

            // Environment setup
            body += `## ðŸŒ Environments Created\n\n`;
            body += `- âœ… \`dev\` - Development environment\n`;
            body += `- âœ… \`staging\` - Staging environment\n`;
            body += `- âœ… \`prod\` - Production environment\n\n`;
            body += `Configure environment-specific settings in **Settings** â†’ **Environments**\n\n`;

            // Security features
            body += `## ðŸ”’ Security Features Enabled\n\n`;
            body += `- âœ… Vulnerability alerts\n`;
            body += `- âœ… Dependabot security updates\n`;
            body += `- âœ… Auto-delete branch after merge\n\n`;

            // Cleanup
            body += `## ðŸ§¹ Template Files Cleaned Up\n\n`;
            body += `The following template-specific files have been automatically removed:\n`;
            body += `- \`rulesets/\` directory - Rulesets already applied to this repo\n`;
            body += `- \`.github/workflows/fork-governance.yaml\` - No longer needed\n`;
            body += `- \`.github/workflows/apply-rulesets.yaml\` - No longer needed\n\n`;
            body += `**Note:** All governance rules are already active via GitHub Rulesets (check Settings â†’ Rules â†’ Rulesets)\n\n`;

            // Required files check
            if (fileWarnings) {
              body += `## âš ï¸ Required Files Need Attention\n\n`;
              const warningList = fileWarnings.split('; ');
              for (const warning of warningList) {
                body += `- âš ï¸ ${warning}\n`;
              }
              body += `\n**Action Required:** Update these files with your project-specific information.\n\n`;
            } else {
              body += `## âœ… Required Files\n\n`;
              body += `- âœ… README.md exists\n`;
              body += `- âœ… CONTRIBUTING.md exists\n\n`;
            }

            // Next steps
            body += `## ðŸš€ Next Steps\n\n`;
            if (nameValid !== 'true') {
              body += `1. **Fix repository name** (see naming section above)\n`;
            }
            if (fileWarnings) {
              body += `1. **Update required files** (see warnings above)\n`;
            }
            body += `1. **Create required workflow files** for status checks:\n`;
            body += `   - \`.github/workflows/pr-checks.yaml\`\n`;
            body += `   - \`.github/workflows/static-code-scan.yaml\`\n`;
            body += `   - \`.github/workflows/terraform-plan.yaml\`\n`;
            body += `1. **Customize README.md** with your project details\n`;
            body += `1. **Configure environments** in Settings â†’ Environments (add secrets, protection rules)\n`;
            body += `1. **Set up AWS credentials** in repository secrets\n`;
            body += `1. **Start developing** - create feature branches following \`type/jira-123\` pattern\n\n`;

            // PR template
            body += `## ðŸ“ Pull Request Template\n\n`;
            body += `A PR template has been included at \`.github/pull_request_template.md\`\n`;
            body += `It will automatically appear when creating PRs and is **enforced by code review**.\n\n`;

            // Documentation
            body += `## ðŸ“š Documentation\n\n`;
            body += `- [Contributing Guidelines](./CONTRIBUTING.md)\n`;
            body += `- [Repository Rulesets](./rulesets/README.md)\n`;
            body += `- [Architecture Diagram](./docs/architect.drawio.png)\n\n`;
            body += `---\n\n`;
            body += `*This issue was automatically created by the Fork Governance workflow.*`;

            // Create the issue
            const labels = ['setup'];
            if (nameValid !== 'true' || fileWarnings) {
              labels.push('action-required');
            }
            if (nameValid !== 'true') {
              labels.push('naming-convention');
            }
            if (fileWarnings) {
              labels.push('documentation');
            }

            const issue = await github.rest.issues.create({
              owner: forkOwner,
              repo: forkRepo,
              title: (nameValid !== 'true' || fileWarnings)
                ? 'âš ï¸ Repository Setup Complete - Action Required'
                : 'âœ… Repository Setup Complete - Review Governance Rules',
              body: body,
              labels: labels
            });

            console.log(`âœ“ Created issue #${issue.data.number}: ${issue.data.html_url}`);

      - name: Clean up governance files in fork
        uses: actions/github-script@v7
        continue-on-error: true
        with:
          github-token: ${{ secrets.GH_PAT }}
          script: |
            const forkOwner = '${{ steps.fork-info.outputs.owner }}';
            const forkRepo = '${{ steps.fork-info.outputs.repo }}';

            console.log('Cleaning up template-specific files from forked repo...');

            // Files to delete (no longer needed in forked repos)
            const filesToDelete = [
              'rulesets/main.json',
              'rulesets/dev.json',
              'rulesets/tag-protection.json',
              'rulesets/branch-naming.json',
              'rulesets/commit-message.json',
              'rulesets/README.md',
              '.github/workflows/fork-governance.yaml',
              '.github/workflows/apply-rulesets.yaml'
            ];

            // Get default branch (should be dev after our changes)
            const repo = await github.rest.repos.get({
              owner: forkOwner,
              repo: forkRepo
            });
            const defaultBranch = repo.data.default_branch;

            console.log(`Default branch: ${defaultBranch}`);

            // Get current commit SHA of default branch
            const ref = await github.rest.git.getRef({
              owner: forkOwner,
              repo: forkRepo,
              ref: `heads/${defaultBranch}`
            });
            const currentCommitSha = ref.data.object.sha;

            // Get current commit to get tree SHA
            const currentCommit = await github.rest.git.getCommit({
              owner: forkOwner,
              repo: forkRepo,
              commit_sha: currentCommitSha
            });
            const currentTreeSha = currentCommit.data.tree.sha;

            // Get current tree
            const currentTree = await github.rest.git.getTree({
              owner: forkOwner,
              repo: forkRepo,
              tree_sha: currentTreeSha,
              recursive: 'true'
            });

            // Create new tree without the files to delete
            const newTree = currentTree.data.tree
              .filter(item => !filesToDelete.includes(item.path))
              .map(item => ({
                path: item.path,
                mode: item.mode,
                type: item.type,
                sha: item.sha
              }));

            // Create new tree object
            const tree = await github.rest.git.createTree({
              owner: forkOwner,
              repo: forkRepo,
              tree: newTree
            });

            // Create commit
            const commit = await github.rest.git.createCommit({
              owner: forkOwner,
              repo: forkRepo,
              message: 'chore: remove template governance files (rulesets already applied)',
              tree: tree.data.sha,
              parents: [currentCommitSha]
            });

            // Update reference
            await github.rest.git.updateRef({
              owner: forkOwner,
              repo: forkRepo,
              ref: `heads/${defaultBranch}`,
              sha: commit.data.sha
            });

            console.log(`âœ“ Cleaned up ${filesToDelete.length} template files`);
            console.log(`âœ“ Created cleanup commit: ${commit.data.sha}`);

      - name: Notify in template repo
        uses: actions/github-script@v7
        continue-on-error: true
        with:
          script: |
            const forkFullName = '${{ steps.fork-info.outputs.full_name }}';
            const forkUrl = '${{ steps.fork-info.outputs.url }}';

            console.log(`Fork created: ${forkFullName}`);
            console.log(`URL: ${forkUrl}`);
            console.log('âœ“ Governance rules applied successfully');
